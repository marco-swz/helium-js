import"./form_dialog.js";import"./check.js";import"./toast.js";import"./button.js";import"./input.js";import"./dialog.js";import"./select.js";import"./utils-DoExkFin.js";const sheet=new CSSStyleSheet;sheet.replaceSync(':host {\r\n    --he-table-row-bg: white;\r\n    overflow: auto;\r\n    width: fit-content;\r\n}\r\n\r\n:host::-webkit-scrollbar {\r\n    width: 10px !important;\r\n}\r\n\r\n:host::-webkit-scrollbar-thumb {\r\n    background-color: darkgrey !important;\r\n    border-radius: 10px !important;\r\n}\r\n\r\ntable {\r\n    border-spacing: 0;\r\n    border-collapse: separate;\r\n    border-radius: var(--he-table-radius, 4px);\r\n}\r\n\r\nthead {\r\n    position: sticky;\r\n    top: 1px;\r\n    z-index: 2;\r\n}\r\n\r\nthead th {\r\n    background-color: var(--he-table-clr-bg-header, white);\r\n    color: var(--he-table-clr-fg-header, black);\r\n    font-weight: 500;\r\n    padding: 7px 12px;\r\n    text-align: center;\r\n    vertical-align: middle;\r\n    text-wrap: nowrap;\r\n    width: 0;\r\n    border-bottom: 1px solid grey;\r\n}\r\n\r\nthead th:hover .label-sorter {\r\n    opacity: 0.5;\r\n}\r\n\r\nthead th div {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 0.7rem;\r\n    justify-content: space-between;\r\n}\r\n\r\nthead td {\r\n    background-color: #0082b4;\r\n    padding: 0px 4px 8px 4px;\r\n    width: 0;\r\n\r\n}\r\n\r\nthead td:first-child {\r\n    display: flex;;\r\n    align-items: center;;\r\n    padding: 3px 15px;\r\n    border-radius: 0;\r\n    width: fit-content;\r\n}\r\n\r\nthead td:last-child {\r\n    border-radius: 0;\r\n    padding-right: 15px;\r\n}\r\n\r\nthead select {\r\n    padding: 0px 3px;\r\n}\r\n\r\nthead a {\r\n    color: rgba(255, 255, 255, 0.5411764706);\r\n    padding-left: 5px;\r\n\r\n}\r\n\r\nthead a:hover {\r\n    color: white;\r\n}\r\n\r\nthead .cont-filter {\r\n    position: relative;    \r\n    width: 100%;\r\n}\r\n\r\nthead .span-colname {\r\n    position: absolute;\r\n    left: 0.3rem;\r\n    pointer-events: none;\r\n    transition: 0.1s ease all;\r\n    top: 0px;\r\n    font-weight: 600;\r\n}\r\n\r\nthead .inp-filter {\r\n    margin: 0;\r\n    padding: 1px 5px;\r\n    font-size: 0.9rem;\r\n    font-weight: 500;\r\n    background-color: transparent;\r\n    outline: none;\r\n    border: 0;\r\n    color: black;\r\n    width: 100%;\r\n    -webkit-appearance: none;\r\n    -moz-appearance: none;\r\n    appearance: none;\r\n    text-indent: 1px;\r\n}\r\n\r\ntbody tr:last-child td:first-child {\r\n    border-bottom-left-radius: var(--he-table-radius, 4px);\r\n}\r\ntbody tr:last-child td:last-child {\r\n    border-bottom-right-radius: var(--he-table-radius, 4px);\r\n}\r\nthead tr:first-child th:first-child {\r\n    border-top-left-radius: var(--he-table-radius, 4px);\r\n    padding-top: 14px;\r\n}\r\nthead tr:first-child th:last-child {\r\n    border-top-right-radius: var(--he-table-radius, 4px);\r\n}\r\n\r\nthead .inp-filter:focus,\r\n.cont-filter input:not(:placeholder-shown),\r\n.cont-filter select:has(option:checked:not([value=""])) {\r\n    transform: translateY(7px);\r\n    font-weight: 600;\r\n    border-bottom: 0.1rem solid darkgrey;\r\n    padding: 4px 5px;\r\n    padding-bottom: 1px;\r\n}\r\n\r\nthead .inp-filter:focus + .span-colname, \r\n.cont-filter input:not(:placeholder-shown) + .span-colname,\r\n.cont-filter select:has(option:checked:not([value=""])) + .span-colname {\r\n    transform: translateY(-5px);\r\n    font-size: 0.7rem;\r\n    opacity: 1;\r\n}\r\n\r\ntbody {\r\n    min-height: 15px;\r\n}\r\n\r\ntbody tr {\r\n    background-color: var(--he-table-row-bg);\r\n}\r\n\r\ntbody tr:nth-child(even) {\r\n    filter: brightness(0.97);\r\n}\r\n\r\ntbody tr:hover {\r\n    filter:brightness(0.93);\r\n}\r\n\r\ntbody td {\r\n    text-wrap: nowrap;\r\n    overflow: hidden;\r\n    text-overflow: ellipsis;\r\n    max-width: 400px;\r\n    padding: 5px 15px;\r\n    vertical-align: middle;\r\n    width: 0;\r\n}\r\n\r\ntbody td > * {\r\n    filter: unset;\r\n}\r\n\r\ntbody td:first-child {\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    width: unset;\r\n}\r\n\r\ntbody td xmp {\r\n    margin: 0;\r\n    overflow: hidden;\r\n    text-overflow: ellipsis;\r\n}\r\n\r\ntbody #row-btn-more {\r\n    background-color: var(--he-table-clr-bg-more, white);\r\n    color: var(--he-table-clr-fg-more, black);\r\n    cursor: pointer;\r\n    text-align: center;\r\n}\r\n\r\ntbody #row-btn-more td:hover {\r\n    border-color: grey;\r\n    background-color: whitesmoke;\r\n}\r\n\r\ntbody #row-btn-more td {\r\n    padding: 0.4rem;\r\n    border: 1px solid darkgrey;\r\n    display: table-cell;\r\n}\r\n\r\n.cont-sorters {\r\n    display: inline-flex;\r\n    flex-direction: column;\r\n    font-size: 0.7rem;\r\n    gap: 0;\r\n    cursor: pointer;\r\n}\r\n\r\n.label-sorter {\r\n    opacity: 0;\r\n}\r\n\r\nthead th div .label-sorter:hover {\r\n    opacity: 1;\r\n}\r\n\r\nthead th div .label-sorter:has(input:checked) {\r\n    opacity: 1;\r\n}\r\n\r\n.label-sorter input {\r\n    display: none;\r\n}\r\n\r\ntable[loading] {\r\n    pointer-events: none;\r\n    cursor: no-drop;\r\n}\r\n\r\ntable[loading] tbody {\r\n    position: relative;\r\n}\r\n\r\ntable[loading] tbody::after {\r\n    content: "";\r\n    position: absolute;\r\n    height: 100%;\r\n    width: 100%;\r\n    top: 0;\r\n    left: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    margin: auto;\r\n    background: linear-gradient(-90deg, #dbd8d8 0%, #fcfcfc 50%, #dbd8d8 100%);\r\n    background-size: 400% 400%;\r\n    animation: pulse 1.2s ease-in-out infinite;\r\n}\r\n\r\n@keyframes pulse {\r\n    0% {\r\n        background-position: 0% 0%\r\n    }\r\n    100% {\r\n        background-position: -135% 0%\r\n    }\r\n}\r\n\r\nhe-form-dialog {\r\n    --he-form-dialog-width: 350px;\r\n}\r\n');class HeliumTable extends HTMLElement{static formAssociated=!0;static observedAttributes=["endpoint","pagination"];endpoint;$checkAll;$form;$formDialogEdit;$body;$diagEdit;dataOld;editRequestType;idsEdit=[];nextRowId=0;pagination;offset=0;remap={};options={};internals;rowColors={};constructor(){super();let t=this.attachShadow({mode:"open"});this.internals=this.attachInternals(),t.adoptedStyleSheets=[sheet]}set loading(t){t?this.$body.parentElement.setAttribute("loading",!0):this.$body.parentElement.removeAttribute("loading")}get loading(){return null!=this.$body.parentElement.getAttribute("loading")}set oncheck(t){this.setAttribute("oncheck",t)}get oncheck(){return this.getAttribute("oncheck")}get value(){return this.getCheckedData()}get validationMessage(){return this.internals.validationMessage}get validity(){return this.internals.validity}attributeChangedCallback(t,e,r){switch(t){case"endpoint":this.endpoint=r;break;case"pagination":this.pagination=Number(r)}}checkValidity(){return this.internals.checkValidity()}connectedCallback(){this._renderTable();for(let t of this.$form.querySelectorAll(".cont-filter")){let e=t.querySelector(".span-colname");t.querySelector(".inp-filter").style.minWidth=e.offsetWidth+"px"}this._requestRows(this.replaceBody),this._updateExternElements([]),this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.getTableData()))}deleteChecked(t=!0){let e=this.shadowRoot.querySelectorAll(".check-row:state(checked)"),r={data:[]};for(let t of e){let e=t.closest("tr"),n=this._getRowData(e);r.data.push(n)}let n=r.data.length;if(0===n)return void window.alert("Keine Zeilen ausgewählt.");const i=n>1?`werden ${n} Zeilen`:"wird 1 Zeile";if(!t||window.confirm(`Es ${i} gelöscht.\nSind Sie sicher?`))if(null==this.endpoint){for(const t of e)t.parentElement.parentElement.remove();this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.getTableData()))}else fetch(this.endpoint,{method:"DELETE",body:JSON.stringify(r)}).then((t=>t.json())).then((t=>{t.forEach(((t,r)=>{t||e[r].closest("tr").remove()}))})).catch((t=>{const e=new CustomEvent("he-toast-error",{detail:t});this.dispatchEvent(e)}))}formEditBeforeSubmitCallback(t){t.fetchArgs.body={data:[JSON.parse(t.fetchArgs.body)]},null!=this.dataOld&&(t.fetchArgs.body.old=[this.dataOld]),t.fetchArgs.method=this.editRequestType,t.fetchArgs.headers={Accept:"application/json","Content-Type":"application/json"},t.fetchArgs.body=JSON.stringify(t.fetchArgs.body)}formEditAfterSubmitCallback(t){t.response.json().then((t=>{switch(this.editRequestType){case"POST":this._requestRows(this.replaceBody);break;case"PATCH":t.forEach(((t,e)=>{const r=this.idsEdit[e];this.replaceRowData(r,t)}))}this.$diagEdit.close()}))}getCheckedData(t=!1){let e=this.shadowRoot.querySelectorAll(".check-row:state(checked)"),r=[];for(let n of e){let e=n.closest("tr"),i=this._getRowData(e,t);r.push(i)}return r}getTableData(t=!1){return this._getTableData(t)}refresh(){this._requestRows(this.replaceBody)}replaceBody(t){this.$body.innerHTML="",this.offset=0,this._updateExternElements([]),this.$checkAll&&(this.$checkAll.checked=!1,this.$checkAll.indeterminate=!1);let e=!1;null!=this.pagination&&t.length>this.pagination&&(t.pop(),e=!0);for(let e of t)this.$body.append(this._renderRow(e));e&&this.$body.append(this._renderButtonMore()),this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.getTableData()))}replaceRowData(t,e){let r=this.$body.querySelector("#"+t);if(null==r)throw new Error("No row found with the row ID "+t);let n=this._getColumns(!0);for(let t=0;t<n.length;++t){const i=n[t],o=e[i.getAttribute("column")];if(null==o)continue;let l=r.children[t+1];l.setAttribute("data",o),l.innerHTML=this._renderText(i,o)}this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.getTableData()))}reportValidity(){return this.internals.reportValidity()}showDialogEdit(){let t=this.shadowRoot.querySelector(".check-row:state(checked)");if(null==t)throw new Error("No row selected");let e=t.parentElement.parentElement;this._showDialogEdit(e)}showDialogDuplicate(){let t=this.shadowRoot.querySelector(".check-row:state(checked)");if(null==t)throw new Error("No row selected");let e=t.parentElement.parentElement,r=this._getRowData(e,!1);this.$diagEdit.setValues(r),this.editRequestType="POST",this.$diagEdit.setAttribute("title-text","Duplizieren"),this.$diagEdit.showModal()}showDialogNew(){this.$diagEdit.reset(),this.editRequestType="POST",this.$diagEdit.setAttribute("title-text","Erstellen"),this.$diagEdit.showModal()}_appendRows(t){null!=this.pagination&&t.length>this.pagination&&t.pop();let e=null;"row-btn-more"===this.$body.lastChild.id&&(e=this.$body.lastChild,this.$body.removeChild(e));for(let e of t)this.$body.append(this._renderRow(e));null!=e&&t.length===this.pagination&&this.$body.append(e)}_checkAllCheckCallback(){this.$checkAll.indeterminate=!1;const t=this.$body.querySelectorAll(".check-row");if(this.$checkAll.checked){for(const e of t)e.checked=!0;this._updateExternElements(t)}else for(const e of t)e.checked=!1,this._updateExternElements([])}_filterChangeCallback(t){if(this.offset=0,null!=this.endpoint)return void this._requestRows(this.replaceBody);const e=t.currentTarget,r=e.value.toLowerCase(),n=Array.prototype.indexOf.call(e.parentElement.parentElement.parentElement.parentElement.children,e.parentElement.parentElement.parentElement);for(const t of this.$body.children){const e=t.children[n].getAttribute("data");let i=t.getAttribute("mask")??0;e.toLowerCase().includes(r)?i&=-2<<n:i|=1<<n,t.setAttribute("mask",i),t.style.visibility=i>0?"collapse":null}}_getColumns(t=!1){return t?this.shadowRoot.querySelectorAll("th[column]"):this.shadowRoot.querySelectorAll("th")}_getRowData(t,e=!1){let r={},n=this._getColumns(!0);for(let i=0;i<n.length;++i){let o=t.children[i+1];r[n[i].getAttribute("column")]=e?o.innerText:o.getAttribute("data")}return r}_getTableData(t=!1){return Array.from(this.$body.children).map((e=>this._getRowData(e,t)))}_handlePagination(){this.offset+=this.pagination??0,this._requestRows(this._appendRows)}_renderSorters(t,e){let r=document.createElement("input");r.type="radio",r.name="sort",r.value=t+"-asc",r.id=t+"-asc",r.onclick=t=>this._sortClickCallback.bind(this)(t,!1),"asc"===e&&(r.checked=!0);let n=document.createElement("label");n.for=t+"asc",n.innerHTML="▲",n.classList.add("label-sorter"),n.append(r);let i=document.createElement("input");i.type="radio",i.name="sort",i.value=t+"-desc",i.id=t+"-desc",i.onclick=t=>this._sortClickCallback.bind(this)(t,!0),"desc"===e&&(i.checked=!0);let o=document.createElement("label");o.for=t+"desc",o.classList.add("label-sorter"),o.innerHTML="▼",o.append(i);let l=document.createElement("div");return l.classList.add("cont-sorters"),l.append(n),l.append(o),l}_showDialogEdit(t){let e=this._getRowData(t,!1);this.$diagEdit.setValues(e),this.dataOld=e,this.idsEdit=[t.id],this.editRequestType="PATCH",this.$diagEdit.setAttribute("title-text","Bearbeiten"),this.$diagEdit.showModal()}_sortClickCallback(t,e){if(this.endpoint)return void this._requestRows(this.replaceBody);let r=t.currentTarget;const n=Array.prototype.indexOf.call(r.parentElement.parentElement.parentElement.parentElement.parentElement.children,r.parentElement.parentElement.parentElement.parentElement);let i=[];for(const t of this.$body.children)i.push([t.children[n].getAttribute("data"),t]);let o=e?Array.from(i).sort(((t,e)=>e[0].localeCompare(t[0]))):Array.from(i).sort(((t,e)=>t[0].localeCompare(e[0])));for(const t of o)this.$body.append(t[1])}_renderButtonMore(){let t=document.createElement("tr");t.id="row-btn-more";let e=document.createElement("td");return e.colSpan="100",e.title="Mehr anzeigen",e.innerHTML="Mehr anzeigen",e.onclick=()=>this._handlePagination(),t.append(e),t}_renderDialogEdit(){let t=[];for(let e of this._getColumns(!0)){const r=e.getAttribute("type"),n=e.getAttribute("column");let i="true"===e.getAttribute("required"),o="hidden"===r;e.getAttribute("no-edit")&&(o=!0,i=!1);const l=this.options[n];let a={};if(null!=l){const t=this.remap[n];for(const e of l){const r=t[e];a[e]=r||e}}t.push({name:e.getAttribute("column"),required:i,label:e.querySelector("span").innerHTML,placeholder:e.getAttribute("default"),pattern:e.getAttribute("pattern"),hidden:o,options:a})}let e=document.createElement("he-form-dialog");return e.renderRows(t),e.setAttribute("endpoint",this.endpoint),e.onsubmit=t=>this.formEditBeforeSubmitCallback.bind(this)(t),e.onresponse=t=>this.formEditAfterSubmitCallback.bind(this)(t),e}_renderRow(t){let e=document.createElement("tr");e.id="row-"+this.nextRowId++,e.onclick=t=>this._rowClickCallback.bind(this)(t);for(let r of this._getColumns()){const n=r.getAttribute("column");let i=t[n]??"",o=i,l=document.createElement("td");switch(r.getAttribute("type")){case"check":let a=document.createElement("he-check");a.name="rows[]",a.value=t.id??"",a.classList.add("check-row"),l.append(a);break;case"edit":l.addEventListener("click",(()=>this._showDialogEdit.bind(this)(e))),l.innerHTML="E";break;case"hidden":l.style.display="none";default:l.setAttribute("data",i),l.innerHTML=this._renderText(r,o),l.title=i;let s=this.rowColors[n];if(s){let t=s[i];t&&(e.style.cssText=`--he-table-row-bg: ${t}`)}}e.append(l)}return e}_requestRows(t){if(null==this.endpoint)return;this.loading=!0;let e=new FormData(this.$form);null!=this.pagination&&(e.append("offset",this.offset),e.append("count",this.pagination+1)),fetch(this.endpoint+"/?"+new URLSearchParams(e).toString(),{method:"GET"}).then((t=>t.json())).then((e=>{t.bind(this)(e)})).catch((t=>{console.error(t)})).finally((()=>this.loading=!1))}_renderText(t,e){let r=e;switch(t.getAttribute("type")){case"date":r=e.split("-").reverse().join(".");break;case"datetime":e=e.replace("T"," ");const[t,n]=e.split(" ");r=t.split("-").reverse().join(".")+" "+n}const n=this.remap[t.getAttribute("column")];if(n){const t=n[e];t&&(r=t)}return r}_renderTable(){const t=this.shadowRoot;this.id=""==this.id?"he-table-"+Math.floor(10000000001*Math.random()):this.id;let e=document.createElement("table");this.$form=document.createElement("form"),this.$form.id="form-tbl",this.$form.append(e),t.append(this.$form);let r=document.createElement("tr"),n=document.createElement("tr");const i=this.querySelectorAll("th");for(let t of i){let e=t.getAttribute("column")??t.innerText;const r=t.getAttribute("type");switch(r){case"check":this.$checkAll=document.createElement("he-check"),this.$checkAll.id="check-all",this.$checkAll.onchange=t=>this._checkAllCheckCallback.bind(this)(t);let t=document.createElement("th");t.setAttribute("type","check"),t.append(this.$checkAll),n.append(t);continue;case"edit":case"delete":case"duplicate":let e=document.createElement("th");e.setAttribute("type",r),n.append(e);continue}let i=document.createElement("div"),o=document.createElement("div");o.classList.add("cont-filter"),i.append(o);let l=document.createElement("span");l.innerHTML=t.innerHTML.trim(),l.classList.add("span-colname"),t.innerHTML="",o.append(l);const a=t.getAttribute("sort");let s=this._renderSorters(e,a);t.setAttribute("column",e),i.append(s),t.append(i),n.append(t),"hidden"===t.getAttribute("type")&&(t.style.display="none");try{this.remap[e]=JSON.parse(t.getAttribute("remap"))}catch(t){throw new Error("The provided remap is not valid JSON!")}try{this.rowColors[e]=JSON.parse(t.getAttribute("row-color"))}catch(t){throw new Error("The provided row-color is not valid JSON!")}const d=t.getAttribute("options");if(d){try{this.options[e]=JSON.parse(d)}catch(t){throw new Error("The provided options are not valid JSON!")}let r=document.createElement("select");r.id="filter-"+e,r.name=e,r.classList.add("inp-filter"),r.onchange=t=>this._filterChangeCallback(t);let n=document.createElement("option");n.value="",r.append(n);for(const n of this.options[e]){const e=this._renderText(t,n);let i=document.createElement("option");i.innerHTML=e,i.value=n,r.append(i)}o.prepend(r)}else{let r=document.createElement("input");r.id="filter-"+e,r.type="text",r.name=e,r.autocomplete="off",r.placeholder=" ",r.classList.add("inp-filter"),r.value=t.getAttribute("filter")??"",r.onchange=t=>this._filterChangeCallback(t),o.prepend(r)}}let o=document.createElement("thead");o.append(n),o.append(r),e.append(o),this.$body=document.createElement("tbody");const l=this.querySelectorAll("tr:has(td)");for(const t of l){let e={},r=0;for(let n=0;n<i.length;++n){const o=i[n],l=o.getAttribute("column");if(!l||["check","edit","duplicate","delete"].includes(o.getAttribute("type")))continue;const a=t.children[r],s=a.getAttribute("data")??a.innerText;e[l]=s,++r}let n=this._renderRow(e);this.$body.append(n)}e.append(this.$body),this.$diagEdit=this._renderDialogEdit(),t.append(this.$diagEdit),this.innerHTML=""}_rowClickCallback(t){const e=t.currentTarget;if(this.$checkAll){let r=this.$body.querySelectorAll(".check-row:state(checked)"),n=r.length;if(!t.target.classList.contains("check-row")){for(let t of r)t.checked=!1;e.children[0].children[0].checked=!0,n=1}0===n?(this.$checkAll.checked=!1,this.$checkAll.indeterminate=!1):n<this.$body.children.length?(this.$checkAll.checked=!0,this.$checkAll.indeterminate=!0):(this.$checkAll.indeterminate=!1,this.$checkAll.checked=!0),r=this.$body.querySelectorAll(".check-row:state(checked)"),this._updateExternElements(r)}else{const t=this.$body.querySelector("tr[selected]");t&&t.removeAttribute("selected"),e.setAttribute("selected",""),this._updateExternElements([e])}}_updateExternElements(checked){this.getAttribute("name")&&null==this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.value));const evt=new CustomEvent("check",{detail:{numRows:checked.length}});this.dispatchEvent(evt);const oncheck=eval(this.oncheck);"function"==typeof oncheck&&oncheck.call(this,evt);for(const t of document.querySelectorAll(`[he-table-notify="#${this.id}"]`))t.setAttribute("he-table-checked",checked.length)}}customElements.get("he-table")||customElements.define("he-table",HeliumTable);export{HeliumTable};
