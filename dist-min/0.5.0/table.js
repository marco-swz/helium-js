import"./form_dialog.js";import"./check.js";import"./toast.js";import"./button.js";import"./input.js";import"./dialog.js";import"./select.js";import"./utils-0yxUIyxA.js";const sheet=new CSSStyleSheet;sheet.replaceSync(':host {\r\n    overflow: auto;\r\n    width: fit-content;\r\n}\r\n\r\n:host::-webkit-scrollbar {\r\n    width: 10px !important;\r\n}\r\n\r\n:host::-webkit-scrollbar-thumb {\r\n    background-color: darkgrey !important;\r\n    border-radius: 10px !important;\r\n}\r\n\r\ntable {\r\n    border-spacing: 0;\r\n    border-collapse: separate;\r\n    border-radius: var(--he-table-radius, 4px);\r\n}\r\n\r\nthead {\r\n    position: sticky;\r\n    top: 1px;\r\n    z-index: 2;\r\n}\r\n\r\nthead th {\r\n    background-color: var(--he-table-clr-bg-header, white);\r\n    color: var(--he-table-clr-fg-header, black);\r\n    font-weight: 500;\r\n    padding: 7px 12px;\r\n    text-align: center;\r\n    vertical-align: middle;\r\n    text-wrap: nowrap;\r\n    width: 0;\r\n    border-bottom: 1px solid grey;\r\n}\r\n\r\nthead th:hover .label-sorter {\r\n    opacity: 0.5;\r\n}\r\n\r\nthead th div {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 0.7rem;\r\n    justify-content: space-between;\r\n}\r\n\r\nthead td {\r\n    background-color: #0082b4;\r\n    padding: 0px 4px 8px 4px;\r\n    width: 0;\r\n\r\n}\r\n\r\nthead td:first-child {\r\n    display: flex;;\r\n    align-items: center;;\r\n    padding: 3px 15px;\r\n    border-radius: 0;\r\n    width: fit-content;\r\n}\r\n\r\nthead td:last-child {\r\n    border-radius: 0;\r\n    padding-right: 15px;\r\n}\r\n\r\nthead select {\r\n    padding: 0px 3px;\r\n}\r\n\r\nthead a {\r\n    color: rgba(255, 255, 255, 0.5411764706);\r\n    padding-left: 5px;\r\n\r\n}\r\n\r\nthead a:hover {\r\n    color: white;\r\n}\r\n\r\nthead .cont-filter {\r\n    position: relative;    \r\n    width: 100%;\r\n}\r\n\r\nthead .span-colname {\r\n    position: absolute;\r\n    left: 0.3rem;\r\n    pointer-events: none;\r\n    transition: 0.1s ease all;\r\n    top: 0px;\r\n    font-weight: 600;\r\n}\r\n\r\nthead .inp-filter {\r\n    margin: 0;\r\n    padding: 1px 5px;\r\n    font-size: 0.9rem;\r\n    font-weight: 500;\r\n    background-color: transparent;\r\n    outline: none;\r\n    border: 0;\r\n    color: black;\r\n    width: 100%;\r\n    -webkit-appearance: none;\r\n    -moz-appearance: none;\r\n    appearance: none;\r\n    text-indent: 1px;\r\n}\r\n\r\ntbody tr:last-child td:first-child {\r\n    border-bottom-left-radius: var(--he-table-radius, 4px);\r\n}\r\ntbody tr:last-child td:last-child {\r\n    border-bottom-right-radius: var(--he-table-radius, 4px);\r\n}\r\nthead tr:first-child th:first-child {\r\n    border-top-left-radius: var(--he-table-radius, 4px);\r\n    padding-top: 14px;\r\n}\r\nthead tr:first-child th:last-child {\r\n    border-top-right-radius: var(--he-table-radius, 4px);\r\n}\r\n\r\nthead .inp-filter:focus,\r\n.cont-filter input:not(:placeholder-shown),\r\n.cont-filter select:has(option:checked:not([value=""])) {\r\n    transform: translateY(7px);\r\n    font-weight: 600;\r\n    border-bottom: 0.1rem solid darkgrey;\r\n    padding: 4px 5px;\r\n    padding-bottom: 1px;\r\n}\r\n\r\nthead .inp-filter:focus + .span-colname, \r\n.cont-filter input:not(:placeholder-shown) + .span-colname,\r\n.cont-filter select:has(option:checked:not([value=""])) + .span-colname {\r\n    transform: translateY(-5px);\r\n    font-size: 0.7rem;\r\n    opacity: 1;\r\n}\r\n\r\ntbody {\r\n    min-height: 15px;\r\n}\r\n\r\ntbody tr:nth-child(even) {\r\n    background-color: whitesmoke;\r\n}\r\n\r\ntbody tr:hover {\r\n    background-color: #dcdcdc;\r\n}\r\n\r\ntbody td {\r\n    text-wrap: nowrap;\r\n    overflow: hidden;\r\n    text-overflow: ellipsis;\r\n    max-width: 400px;\r\n    padding: 5px 15px;\r\n    vertical-align: middle;\r\n    width: 0;\r\n}\r\n\r\ntbody td:first-child {\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    width: unset;\r\n}\r\n\r\ntbody td xmp {\r\n    margin: 0;\r\n    overflow: hidden;\r\n    text-overflow: ellipsis;\r\n}\r\n\r\ntbody #row-btn-more {\r\n    background-color: var(--he-table-clr-bg-more, white);\r\n    color: var(--he-table-clr-fg-more, black);\r\n    cursor: pointer;\r\n    text-align: center;\r\n}\r\n\r\ntbody #row-btn-more td:hover {\r\n    border-color: grey;\r\n    background-color: whitesmoke;\r\n}\r\n\r\ntbody #row-btn-more td {\r\n    padding: 0.4rem;\r\n    border: 1px solid darkgrey;\r\n}\r\n\r\n.cont-sorters {\r\n    display: inline-flex;\r\n    flex-direction: column;\r\n    font-size: 0.7rem;\r\n    gap: 0;\r\n    cursor: pointer;\r\n}\r\n\r\n.label-sorter {\r\n    opacity: 0;\r\n}\r\n\r\nthead th div .label-sorter:hover {\r\n    opacity: 1;\r\n}\r\n\r\nthead th div .label-sorter:has(input:checked) {\r\n    opacity: 1;\r\n}\r\n\r\n.label-sorter input {\r\n    display: none;\r\n}\r\n\r\ntable[loading] {\r\n    pointer-events: none;\r\n    cursor: no-drop;\r\n}\r\n\r\ntable[loading] tbody {\r\n    position: relative;\r\n}\r\n\r\ntable[loading] tbody::after {\r\n    content: "";\r\n    position: absolute;\r\n    height: 100%;\r\n    width: 100%;\r\n    top: 0;\r\n    left: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    margin: auto;\r\n    background: linear-gradient(-90deg, #dbd8d8 0%, #fcfcfc 50%, #dbd8d8 100%);\r\n    background-size: 400% 400%;\r\n    animation: pulse 1.2s ease-in-out infinite;\r\n}\r\n\r\n@keyframes pulse {\r\n    0% {\r\n        background-position: 0% 0%\r\n    }\r\n    100% {\r\n        background-position: -135% 0%\r\n    }\r\n}\r\n');class HeliumTable extends HTMLElement{static observedAttributes=["endpoint","pagination"];endpoint;$checkAll;$form;$formDialogEdit;$body;$diagEdit;dataOld;editRequestType;idsEdit=[];nextRowId=0;pagination;offset=0;remap={};options={};constructor(){super(),this.attachShadow({mode:"open"}).adoptedStyleSheets=[sheet]}set loading(e){e?this.$body.parentElement.setAttribute("loading",!0):this.$body.parentElement.removeAttribute("loading")}get loading(){return null!=this.$body.parentElement.getAttribute("loading")}set oncheck(e){this.setAttribute("oncheck",e)}get oncheck(){return this.getAttribute("oncheck")}attributeChangedCallback(e,t,n){switch(e){case"endpoint":this.endpoint=n;break;case"pagination":this.pagination=Number(n)}}connectedCallback(){const e=this.shadowRoot;this.id=""==this.id?"he-table-"+Math.floor(10000000001*Math.random()):this.id;let t=document.createElement("table");this.$form=document.createElement("form"),this.$form.id="form-tbl",this.$form.append(t),e.append(this.$form);let n=document.createElement("tr"),r=document.createElement("tr");const i=this.querySelectorAll("th");for(let e of i){let t=e.getAttribute("column")??e.innerText,n=document.createElement("div"),i=document.createElement("div");i.classList.add("cont-filter"),n.append(i);let o=document.createElement("span");o.innerHTML=e.innerHTML.trim(),o.classList.add("span-colname"),e.innerHTML="",i.append(o);let l=this._renderSorters(t);e.setAttribute("column",t),n.append(l),e.append(n),r.append(e),"hidden"===e.getAttribute("type")&&(e.style.display="none");try{this.remap[t]=JSON.parse(e.getAttribute("remap"))}catch(e){throw new Error("The provided remap is not valid JSON!")}const a=e.getAttribute("options");if(a){try{this.options[t]=JSON.parse(a)}catch(e){throw new Error("The provided options are not valid JSON!")}let n=document.createElement("select");n.id="filter-"+t,n.name=t,n.classList.add("inp-filter"),n.onchange=e=>this._filterChangeCallback(e);let r=document.createElement("option");r.value="",n.append(r);for(const r of this.options[t]){const t=this._renderText(e,r);let i=document.createElement("option");i.innerHTML=t,i.value=r,n.append(i)}i.prepend(n)}else{let n=document.createElement("input");n.id="filter-"+t,n.type="text",n.name=t,n.autocomplete="off",n.placeholder=" ",n.classList.add("inp-filter"),n.value=e.getAttribute("filter")??"",n.onchange=e=>this._filterChangeCallback(e),i.prepend(n)}}this.$checkAll=document.createElement("he-check"),this.$checkAll.id="check-all",this.$checkAll.onchange=e=>this._checkAllCheckCallback.bind(this)(e);let o=document.createElement("th");o.append(this.$checkAll),r.prepend(o);let l=document.createElement("thead");l.append(r),l.append(n),t.append(l),this.$body=document.createElement("tbody");const a=this.querySelectorAll("tr:has(td)");for(const e of a){let t={};for(let n=0;n<i.length;++n){const r=e.children[n],o=i[n],l=r.getAttribute("data")??r.innerText;t[o.getAttribute("column")??o.innerText]=l}let n=this._renderRow(t);this.$body.append(n)}t.append(this.$body),this.$diagEdit=this._renderDialogEdit(),e.append(this.$diagEdit),this.innerHTML="";for(let e of this.$form.querySelectorAll(".cont-filter")){let t=e.querySelector(".span-colname");e.querySelector(".inp-filter").style.minWidth=t.offsetWidth+"px"}this._requestRows(this.replaceBody),this._updateExternElements([])}deleteChecked(e=!0){let t=this.shadowRoot.querySelectorAll(".check-row:state(checked)"),n={data:[]};for(let e of t){let t=e.closest("tr"),r=this._getRowData(t);n.data.push(r)}let r=n.data.length;if(0===r)return void window.alert("Keine Zeilen ausgewählt.");const i=r>1?`werden ${r} Zeilen`:"wird 1 Zeile";if(!e||window.confirm(`Es ${i} gelöscht.\nSind Sie sicher?`))if(null==this.endpoint)for(const e of t)e.parentElement.parentElement.remove();else fetch(this.endpoint,{method:"DELETE",body:JSON.stringify(n)}).then((e=>e.json())).then((e=>{e.forEach(((e,n)=>{e||t[n].closest("tr").remove()}))})).catch((e=>{const t=new CustomEvent("he-toast-error",{detail:e});this.dispatchEvent(t)}))}formEditBeforeSubmitCallback(e){e.fetchArgs.body={data:[JSON.parse(e.fetchArgs.body)]},null!=this.dataOld&&(e.fetchArgs.body.old=[this.dataOld]),e.fetchArgs.method=this.editRequestType,e.fetchArgs.headers={Accept:"application/json","Content-Type":"application/json"},e.fetchArgs.body=JSON.stringify(e.fetchArgs.body)}formEditAfterSubmitCallback(e){e.response.json().then((e=>{switch(this.editRequestType){case"POST":this._requestRows(this.replaceBody);break;case"PATCH":e.forEach(((e,t)=>{const n=this.idsEdit[t];this.replaceRowData(n,e)}))}this.$diagEdit.close()}))}getCheckedData(e=!1){let t=this.shadowRoot.querySelectorAll(".check-row:state(checked)"),n=[];for(let r of t){let t=r.closest("tr"),i=this._getRowData(t,e);n.push(i)}return n}refresh(){this._requestRows(this.replaceBody)}replaceBody(e){this.$body.innerHTML="",this.offset=0,this._updateExternElements([]),this.$checkAll.checked=!1,this.$checkAll.indeterminate=!1;let t=!1;null!=this.pagination&&e.length>this.pagination&&(e.pop(),t=!0);for(let t of e)this.$body.append(this._renderRow(t));t&&this.$body.append(this._renderButtonMore())}replaceRowData(e,t){let n=this.$body.querySelector("#"+e);if(null==n)throw new Error("No row found with the row ID "+e);let r=this._getColumns();for(let e=0;e<r.length;++e){const i=r[e],o=t[i.getAttribute("column")];if(null==o)continue;let l=n.children[e+1];l.setAttribute("data",o),l.innerHTML=this._renderText(i,o)}}showDialogEdit(){let e=this.shadowRoot.querySelector(".check-row:state(checked)");if(null==e)throw new Error("No row selected");let t=e.parentElement.parentElement,n=this._getRowData(t,!0);this.$diagEdit.setValues(n),this.dataOld=n,this.idsEdit=[t.id],this.editRequestType="PATCH",this.$diagEdit.setAttribute("title-text","Bearbeiten"),this.$diagEdit.showModal()}showDialogDuplicate(){let e=this.shadowRoot.querySelector(".check-row:state(checked)");if(null==e)throw new Error("No row selected");let t=e.parentElement.parentElement,n=this._getRowData(t,!0);this.$diagEdit.setValues(n),this.editRequestType="POST",this.$diagEdit.setAttribute("title-text","Duplizieren"),this.$diagEdit.showModal()}showDialogNew(){this.$diagEdit.reset(),this.editRequestType="POST",this.$diagEdit.setAttribute("title-text","Erstellen"),this.$diagEdit.showModal()}_appendRows(e){null!=this.pagination&&e.length>this.pagination&&e.pop();let t=null;"row-btn-more"===this.$body.lastChild.id&&(t=this.$body.lastChild,this.$body.removeChild(t));for(let t of e)this.$body.append(this._renderRow(t));null!=t&&e.length===this.pagination&&this.$body.append(t)}_checkAllCheckCallback(){this.$checkAll.indeterminate=!1;const e=this.$body.querySelectorAll(".check-row");if(this.$checkAll.checked){for(const t of e)t.checked=!0;this._updateExternElements(e)}else for(const t of e)t.checked=!1,this._updateExternElements([])}_filterChangeCallback(e){if(this.offset=0,null!=this.endpoint)return void this._requestRows(this.replaceBody);const t=e.currentTarget,n=t.value.toLowerCase(),r=Array.prototype.indexOf.call(t.parentElement.parentElement.parentElement.parentElement.children,t.parentElement.parentElement.parentElement);for(const e of this.$body.children){const t=e.children[r].getAttribute("data");let i=e.getAttribute("mask")??0;t.toLowerCase().includes(n)?i&=-2<<r:i|=1<<r,e.setAttribute("mask",i),e.style.visibility=i>0?"collapse":null}}_getColumns(){return this.shadowRoot.querySelectorAll("th[column]")}_getRowData(e,t=!1){let n={},r=this._getColumns();for(let i=0;i<r.length;++i){let o=e.children[i+1];n[r[i].getAttribute("column")]=t?o.innerText:o.getAttribute("data")}return n}_handlePagination(){this.offset+=this.pagination??0,this._requestRows(this._appendRows)}_renderSorters(e){let t=document.createElement("input");t.type="radio",t.name="sort",t.value=e+"-asc",t.id=e+"-asc",t.onclick=e=>this._sortClickCallback.bind(this)(e,!1);let n=document.createElement("label");n.for=e+"asc",n.innerHTML="▲",n.classList.add("label-sorter"),n.append(t);let r=document.createElement("input");r.type="radio",r.name="sort",r.value=e+"-desc",r.id=e+"-desc",r.onclick=e=>this._sortClickCallback.bind(this)(e,!0);let i=document.createElement("label");i.for=e+"desc",i.classList.add("label-sorter"),i.innerHTML="▼",i.append(r);let o=document.createElement("div");return o.classList.add("cont-sorters"),o.append(n),o.append(i),o}_sortClickCallback(e,t){if(this.endpoint)return void this._requestRows(this.replaceBody);let n=e.currentTarget;const r=Array.prototype.indexOf.call(n.parentElement.parentElement.parentElement.parentElement.parentElement.children,n.parentElement.parentElement.parentElement.parentElement);let i=[];for(const e of this.$body.children)i.push([e.children[r].getAttribute("data"),e]);let o=t?Array.from(i).sort(((e,t)=>t[0].localeCompare(e[0]))):Array.from(i).sort(((e,t)=>e[0].localeCompare(t[0])));for(const e of o)this.$body.append(e[1])}_renderButtonMore(){let e=document.createElement("tr");e.id="row-btn-more";let t=document.createElement("td");return t.colSpan="100",t.title="Mehr anzeigen",t.innerHTML="Mehr anzeigen",t.onclick=()=>this._handlePagination(),e.append(t),e}_renderDialogEdit(){let e=[];for(let t of this._getColumns()){let n="true"===t.getAttribute("required"),r="hidden"===t.getAttribute("type");t.getAttribute("no-edit")&&(r=!0,n=!1);const i=t.getAttribute("column"),o=this.options[i];e.push({name:t.getAttribute("column"),required:n,label:t.querySelector("span").innerHTML,placeholder:t.getAttribute("default"),pattern:t.getAttribute("pattern"),hidden:r,options:o})}let t=document.createElement("he-form-dialog");return t.renderRows(e),t.setAttribute("endpoint",this.endpoint),t.onsubmit=e=>this.formEditBeforeSubmitCallback.bind(this)(e),t.onresponse=e=>this.formEditAfterSubmitCallback.bind(this)(e),t}_renderRow(e){let t=document.createElement("he-check");t.name="rows[]",t.value=e.id??"",t.classList.add("check-row");let n=document.createElement("td");n.append(t);let r=document.createElement("tr");r.id="row-"+this.nextRowId++,r.append(n),r.onclick=e=>this._rowClickCallback.bind(this)(e);for(let t of this._getColumns()){let n=t.getAttribute("column"),i=t.getAttribute("type"),o=document.createElement("td"),l=e[n]??"",a=l;o.innerHTML=this._renderText(t,a),o.setAttribute("data",l),o.title=l,"hidden"===i&&(o.style.display="none"),r.append(o)}return r}_requestRows(e){if(null==this.endpoint)return;this.loading=!0;let t=new FormData(this.$form);null!=this.pagination&&(t.append("offset",this.offset),t.append("count",this.pagination+1)),fetch(this.endpoint+"/?"+new URLSearchParams(t).toString(),{method:"GET"}).then((e=>e.json())).then((t=>{e.bind(this)(t)})).catch((e=>{console.error(e)})).finally((()=>this.loading=!1))}_renderText(e,t){let n=t;switch(e.getAttribute("type")){case"date":n=t.split("-").reverse().join(".");break;case"datetime":t=t.replace("T"," ");const[e,r]=t.split(" ");n=e.split("-").reverse().join(".")+" "+r}const r=this.remap[e.getAttribute("column")];if(r){const e=r[t];e&&(n=e)}return n}_rowClickCallback(e){const t=e.currentTarget;let n=this.$body.querySelectorAll(".check-row:state(checked)"),r=n.length;if(!e.target.classList.contains("check-row")){for(let e of n)e.checked=!1;t.children[0].children[0].checked=!0,r=1}0===r?(this.$checkAll.checked=!1,this.$checkAll.indeterminate=!1):r<this.$body.children.length?(this.$checkAll.checked=!0,this.$checkAll.indeterminate=!0):(this.$checkAll.indeterminate=!1,this.$checkAll.checked=!0),n=this.$body.querySelectorAll(".check-row:state(checked)"),this._updateExternElements(n)}_updateExternElements(checked){const evt=new CustomEvent("check",{detail:{numRows:checked.length}});this.dispatchEvent(evt);const oncheck=eval(this.oncheck);"function"==typeof oncheck&&oncheck.call(this,evt);for(const e of document.querySelectorAll(`[he-table-checked="#${this.id}"]`))switch(e.classList.remove(".he-table-checked-none"),e.classList.remove(".he-table-checked-one"),e.classList.remove(".he-table-checked-multiple"),checked.length){case 0:e.setAttribute("he-table-state","none");break;case 1:e.setAttribute("he-table-state","one");break;default:e.setAttribute("he-table-state","multiple")}}}customElements.get("he-table")||customElements.define("he-table",HeliumTable);export{HeliumTable};
