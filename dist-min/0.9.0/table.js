import"./form_dialog.js";import"./check.js";import"./dialog.js";import"./toggle.js";import"./toast.js";import"./button.js";import"./input.js";import"./utils-DoExkFin.js";import"./select.js";const t=new CSSStyleSheet;t.replaceSync(':host {\n    --he-table-row-backgroundColor: white;\n    --he-table-column-maxWidth: 300px;\n    --he-table-borderRadius: 4px;\n    --he-table-header-color: black;\n    --he-table-header-backgroundColor: white;\n    --he-table-header-borderBottom: 1px solid black;\n    --he-table-tableLayout: auto;\n    --he-table-width: fit-content;\n    --he-table-row-borderBottomColor: hsl(from var(--he-table-row-backgroundColor) h s calc(l - 20));\n\n    overflow: auto;\n    display: inline-block;\n    scrollbar-gutter: stable both-edges;\n    outline: none;\n}\n\n:host::-webkit-scrollbar {\n    width: 10px !important;\n}\n\n:host::-webkit-scrollbar-thumb {\n    background-color: darkgrey !important;\n    border-radius: 10px !important;\n}\n\ntable {\n    table-layout: var(--he-table-tableLayout);\n    width: var(--he-table-width);\n    border-spacing: 0;\n    border-collapse: separate;\n    border-radius: var(--he-table-borderRadius);\n}\n\nthead {\n    position: sticky;\n    top: -1px;\n    z-index: 2;\n}\n\nthead th {\n    background-color: var(--he-table-header-backgroundColor);\n    color: var(--he-table-header-color);\n    font-weight: 500;\n    padding: 5px 0px 5px 15px;\n    text-align: center;\n    vertical-align: middle;\n    text-wrap: nowrap;\n    width: inherit;\n}\n\n:host([filter=below]) {\n    & thead th {\n        padding-bottom: 0;\n        border-bottom: 0;\n    }\n}\n\n:host([column-menu]) {\n    & thead {\n        & tr:first-child th {\n            border-bottom: var(--he-table-header-borderBottom);\n        }\n\n        & th:not([type=check]) {\n            padding: 5px 0 5px 5px;\n\n            & .cont-colname {\n                width: 100%;\n                background-color: var(--he-table-header-backgroundColor);\n                cursor: pointer;\n                border-radius: 4px;\n\n                &:hover {\n                    transition:\n                        background-color 0.2s;\n                    background-color: hsl(from var(--he-table-header-backgroundColor) h s calc(l - 7));\n                }\n            }\n\n            & .span-colname {\n                padding: 7px 10px;\n                width: fit-content;\n                text-align: left;\n                position: relative;\n\n                &::after {\n                    font-family: "Font Awesome 5 Pro";\n                    content: "\\f107";\n                    color: grey;\n                    width: 10px;\n                    height: 15px;\n                    right: 5px;\n                    padding: 0 5px;\n                }\n            }\n\n            &[filter] .span-colname::after {\n                content: "\\f0b0";\n                background-color: inherit;\n                color: steelblue;\n            }\n\n            &[sort=desc] .span-colname::after {\n                content: "\\f354";\n                background-color: inherit;\n                color: steelblue;\n            }\n\n            &[sort=asc] .span-colname::after {\n                content: "\\f357";\n                background-color: inherit;\n                color: steelblue;\n            }\n\n            &[sort=asc][filter] .span-colname::after {\n                content: "\\f0b0\\f357";\n                background-color: inherit;\n                padding-right: 15px;\n                padding-bottom: 2px;\n                color: steelblue;\n            }\n\n            &[sort=desc][filter] .span-colname::after {\n                content: "\\f0b0\\f354";\n                background-color: inherit;\n                padding-right: 15px;\n                padding-bottom: 2px;\n                color: steelblue;\n            }\n        }\n\n    }\n}\n\n#diag-column {\n    & #form-column {\n        display: flex;\n        gap: 10px;\n        flex-direction: column;\n        width: 250px;\n\n        & label {\n            font-weight: 500;\n            font-size: 16px;\n        }\n\n        & #sel-filter-column, & #inp-filter-column {\n            width: 100%;\n        }\n\n        #toggle-asc, #toggle-desc {\n            width: 40%;\n        }\n    }\n}\n\nthead th:hover .label-sorter {\n    opacity: 0.5;\n}\n\nthead th div {\n    display: flex;\n    align-items: center;\n    gap: 0.7rem;\n    justify-content: space-between;\n}\n\nthead td {\n    background-color: var(--he-table-header-backgroundColor);\n    width: 0;\n}\n\nthead td:has(#check-all) {\n    display: flex;\n    align-items: center;\n    padding: 6px 16px;\n    width: fit-content;\n}\n\nthead td:last-child {\n    border-radius: 0;\n    padding-right: 15px;\n}\n\nthead select {\n    padding: 0px 3px;\n}\n\nthead a {\n    color: rgba(255, 255, 255, 0.5411764706);\n    padding-left: 5px;\n\n}\n\nthead a:hover {\n    color: white;\n}\n\nthead .cont-filter {\n    position: relative;    \n    width: 100%;\n}\n\n.span-colname {\n    font-weight: 600;\n}\n\n:host([filter=below]) {\n    & thead tr:last-child {\n        display: table-row;\n\n        & td {\n            border-bottom: var(--he-table-header-borderBottom);\n        }\n    }\n}\n\nthead tr:first-child th {\n    border-bottom: var(--he-table-header-borderBottom);\n}\n\nthead .inp-filter {\n    margin: 0;\n    padding: 1px 5px;\n    font-size: 12px;\n    font-weight: 500;\n    background-color: transparent;\n    outline: none;\n    border: 0;\n    color: black;\n    -webkit-appearance: none;\n    -moz-appearance: none;\n    appearance: none;\n    text-indent: 1px;\n}\n\ntbody tr:last-child td:first-child {\n    border-bottom-left-radius: var(--he-table-borderRadius);\n}\ntbody tr:last-child td:last-child {\n    border-bottom-right-radius: var(--he-table-borderRadius);\n}\nthead tr:first-child th:first-child {\n    border-top-left-radius: var(--he-table-borderRadius);\n}\nthead tr:first-child th:last-child {\n    border-top-right-radius: var(--he-table-borderRadius);\n}\n\nthead th[type="check"] {\n    padding: 14px 0 6px 0;\n}\n\nthead tr.row-filter {\n    & .inp-filter {\n        background-color: whitesmoke;\n        border-bottom: 1px solid grey;\n        font-size: 14px;\n        padding: 2px 5px;\n        font-weight: 700;\n        width: 100%;\n    }\n\n    & td {\n        overflow: hidden;\n        padding: 2px 7px;\n        padding-top: 0;\n    }\n}\n\ntbody tr {\n    background-color: var(--he-table-row-backgroundColor);\n}\n\ntbody tr:hover {\n    background-color: hsl(from var(--he-table-row-backgroundColor) h s calc(l - 5));\n}\n\n/*tbody tr[selected] {*/\n    /*background-color: hsl(from var(--he-table-row-backgroundColor) h s calc(l - 7));*/\n/*}*/\n\ntbody td {\n    text-wrap: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    max-width: var(--he-table-column-maxWidth);\n    padding: 5px 15px;\n    vertical-align: middle;\n    width: 0;\n    border-bottom: 1px solid black;\n    border-bottom-color: var(--he-table-row-borderBottomColor);\n    height: 20px;\n}\n\ntbody td > * {\n    filter: unset;\n}\n\ntbody td:first-child:has(he-check) {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: unset;\n}\n\ntbody tr[selected] td {\n    border-bottom-color: var(--he-table-row-selected-borderBottomColor, var(--he-table-row-borderBottomColor));\n}\n\n\ntbody td xmp {\n    margin: 0;\n    overflow: hidden;\n    text-overflow: ellipsis;\n}\n\ntbody #row-btn-more {\n    background-color: white;\n    color: black;\n    cursor: pointer;\n    text-align: center;\n}\n\ntbody #row-btn-more td:hover {\n    border-color: grey;\n    background-color: whitesmoke;\n}\n\ntbody #row-btn-more td {\n    padding: 0.4rem;\n    border: 1px solid darkgrey;\n    display: table-cell;\n}\n\ntbody #row-empty {\n    &:hover {\n        background-color: white;\n    }\n\n    & td {\n        border-bottom: 0;\n    }\n}\n\n.cont-sorters {\n    display: inline-flex;\n    flex-direction: column;\n    font-size: 0.7rem;\n    gap: 0;\n    cursor: pointer;\n}\n\n.label-sorter {\n    opacity: 0;\n}\n\nthead th div .label-sorter:hover {\n    opacity: 1;\n}\n\nthead th div .label-sorter:has(input:checked) {\n    opacity: 1;\n}\n\n.label-sorter input {\n    display: none;\n}\n\ntable[loading] {\n    pointer-events: none;\n    cursor: no-drop;\n}\n\ntable[loading] tbody {\n    position: relative;\n}\n\ntable[loading] tbody::after {\n    content: "";\n    position: absolute;\n    height: 100%;\n    width: 100%;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    margin: auto;\n    background: linear-gradient(-90deg, #dbd8d8 0%, #fcfcfc 50%, #dbd8d8 100%);\n    background-size: 400% 400%;\n    animation: pulse 1.2s ease-in-out infinite;\n}\n\n@keyframes pulse {\n    0% {\n        background-position: 0% 0%\n    }\n    100% {\n        background-position: -135% 0%\n    }\n}\n\nhe-form-dialog {\n    --he-form-dialog-width: 350px;\n}\n');class e extends HTMLElement{static formAssociated=!0;static observedAttributes=["endpoint","pagination"];endpoint;$checkAll;$form;$formDialogEdit;$body;$diagEdit;$diagColumn;dataOld;editRequestType;idsEdit=[];nextRowId=0;pagination;disableRequest=!1;offset=0;remap={};options={};internals;rowColors={};rowStyles={};cellStyles={};constructor(){super();let e=this.attachShadow({mode:"open"});this.internals=this.attachInternals(),e.adoptedStyleSheets=[t]}set loading(t){t?this.$body.parentElement.setAttribute("loading",!0):this.$body.parentElement.removeAttribute("loading")}get loading(){return null!=this.$body.parentElement.getAttribute("loading")}get value(){return this.getCheckedData()}get validationMessage(){return this.internals.validationMessage}get validity(){return this.internals.validity}attributeChangedCallback(t,e,n){switch(t){case"endpoint":this.endpoint=n;break;case"pagination":this.pagination=Number(n)}}checkValidity(){return this.internals.checkValidity()}connectedCallback(){this._renderTable();for(let t of this.$form.querySelectorAll(".cont-filter")){let e=t.querySelector(".span-colname");t.querySelector(".inp-filter").style.minWidth=e.offsetWidth+"px"}this._requestRows(this.replaceBody),this._updateExternElements([]),this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.getTableData())),this.$form.addEventListener("input",(t=>t.stopPropagation()))}deleteChecked(t=!0){let e=this.shadowRoot.querySelectorAll(".check-row:state(checked)"),n={data:[]};for(let t of e){let e=t.closest("tr"),o=this._getRowData(e);n.data.push(o)}let o=n.data.length;if(0===o)return void window.alert("Keine Zeilen ausgewählt.");const r=o>1?`werden ${o} Zeilen`:"wird 1 Zeile";if(!t||window.confirm(`Es ${r} gelöscht.\nSind Sie sicher?`))if(null==this.endpoint){for(const t of e)t.parentElement.parentElement.remove();this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.getTableData()))}else fetch(this.endpoint,{method:"DELETE",body:JSON.stringify(n)}).then((t=>t.json())).then((t=>{t.forEach(((t,n)=>{t||e[n].closest("tr").remove()}))})).catch((t=>{const e=new CustomEvent("he-toast-error",{detail:t});this.dispatchEvent(e)}))}filterColumn(t,e,n=!1){let o=this._columnFromName(t);return this._filterColumn(o,e,n),this}formEditBeforeSubmitCallback(t){t.fetchArgs.body={data:[JSON.parse(t.fetchArgs.body)]},null!=this.dataOld&&(t.fetchArgs.body.old=[this.dataOld]),t.fetchArgs.method=this.editRequestType,t.fetchArgs.headers={Accept:"application/json","Content-Type":"application/json"},t.fetchArgs.body=JSON.stringify(t.fetchArgs.body)}formEditAfterSubmitCallback(t){t.response.json().then((t=>{switch(this.editRequestType){case"POST":this._requestRows(this.replaceBody);break;case"PATCH":t.forEach(((t,e)=>{const n=this.idsEdit[e];this.replaceRowData(n,t)}))}this.$diagEdit.close()}))}getColumnNames(){const t=this._getColumns(!0),e=[];for(const n of t){const t=n.getAttribute("column");null!=t&&(e[t]=n.querySelector(".span-colname").innerText)}return e}getCheckedData(t=!1){let e=this.shadowRoot.querySelectorAll(".check-row:state(checked)"),n=[];for(let o of e){let e=o.closest("tr"),r=this._getRowData(e,t);n.push(r)}return n}getTableData(t=!1){return this._getTableData(t)}mergeData(t,e,n=!1){Array.isArray(t)||(t=[t]);let o={};for(const n of this.$body.rows){if("row-empty"===n.id){e.length>0&&n.remove();continue}const r=this._getRowData(n);o[t.map((t=>r[t])).join("-")]=n}const r=this._getColumns(!0);for(const n of e){const e=t.map((t=>n[t])).join("-");let l=o[e];if(delete o[e],null!=l){l.style.removeProperty("--he-table-row-backgroundColor");for(const t of r){const e=t.getAttribute("column");if(!(e in n))continue;const o=n[e]??"";let r=l.cells[t.cellIndex];r.setAttribute("data",o);const i=this._renderText(t,o);r.innerHTML=i,r.title=i,this._applyRowStyles(l,e,o)}this._applyRowFilter(l,r)}else l=this._renderRow(n),this.$body.append(l),this._applyRowFilter(l,r)}if(n)for(const t of Object.values(o))t.remove()}refresh(){this._requestRows(this.replaceBody)}replaceBody(t){this.$body.innerHTML="",this.offset=0,this._updateExternElements([]),this.$checkAll&&(this.$checkAll.checked=!1,this.$checkAll.indeterminate=!1),0===t.length&&this.$body.append(this._renderRowEmpty());let e=!1;null!=this.pagination&&t.length>this.pagination&&(t.pop(),e=!0);for(let e of t)this.$body.append(this._renderRow(e));e&&this.$body.append(this._renderButtonMore()),this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.getTableData()))}replaceRowData(t,e){let n=this.$body.querySelector("#"+t);if(null==n)throw new Error("No row found with the row ID "+t);let o=this._getColumns(!0);for(let t=0;t<o.length;++t){const r=o[t],l=e[r.getAttribute("column")];if(null==l)continue;let i=n.children[t+1];i.setAttribute("data",l),i.innerHTML=this._renderText(r,l)}this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.getTableData()))}reportValidity(){return this.internals.reportValidity()}selectRows(t){Array.isArray(t)||(t=[t]);for(const e of t)for(let t of this.$body.children){const n=this._getRowData(t);let o=!0;for(const[t,r]of Object.entries(e))if(n[t]!==r){o=!1;break}o&&(t.querySelector(".check-row")??t).click()}}setRowData(t,e){let n={};for(const t of this._getColumns(!0))n[colName]=t;for(const o of this.$body.rows){let r=!0;for(const[e,l]of Object.entries(t)){const t=n[e];if(null==idx)throw new Error(`No column with name '${e}'!`);if(l!==o.cells[t.cellIndex].getAttribute("data")){r=!1;break}}if(r)for(const[t,r]of Object.entries(e)){const e=n[t],l=o.cells[e.cellIndex];l.setAttribute("data",r),l.innerHTML=this._renderText(e,r)}}return this}showDialogEdit(){this.$diagEdit.reset();let t=this.shadowRoot.querySelector(".check-row:state(checked)");if(null==t)throw new Error("No row selected");let e=t.parentElement.parentElement;this._showDialogEdit(e)}showDialogDuplicate(){this.$diagEdit.reset();let t=this.shadowRoot.querySelector(".check-row:state(checked)");if(null==t)throw new Error("No row selected");let e=t.parentElement.parentElement,n=this._getRowData(e,!1);this.$diagEdit.setValues(n),this.editRequestType="POST",this.$diagEdit.setAttribute("title-text","Duplizieren"),this.$diagEdit.showModal()}showDialogNew(){this.$diagEdit.reset(),this.editRequestType="POST",this.$diagEdit.setAttribute("title-text","Erstellen"),this.$diagEdit.showModal()}sortColumn(t,e){let n=this._columnFromName(t);return this._sortColumn(n,e),this}_appendRows(t){null!=this.pagination&&t.length>this.pagination&&t.pop();let e=null;"row-btn-more"===this.$body.lastChild.id&&(e=this.$body.lastChild,this.$body.removeChild(e));for(let e of t)this.$body.append(this._renderRow(e));null!=e&&t.length===this.pagination&&this.$body.append(e)}_applyCellStyles(t,e,n){let o=this.cellStyles[e];if(null===o)return;if(o=o[n],null===o)return void(t.style.cssText="");let r=o[n];t.style.cssText=r||""}_applyColumnClickCallback(){const t=Object.fromEntries(new FormData(this.$diagColumn.querySelector("#form-column")).entries());this.disableRequest=!0;let e=this._columnFromName(t.column);const n=t.filter??t["filter-sel"];this._filterColumn(e,n),this.disableRequest=!1,this._sortColumn(e,t.sort),this.$diagColumn.close()}_applyRowStyles(t,e,n){let o=this.rowStyles[e];if(o){let e=o[n];t.style.cssText=e||""}let r=this.rowColors[e];if(r){let e=r[n];e&&t.style.setProperty("--he-table-row-backgroundColor",e)}}_applyFilters(t){let e={};for(const n of this.$body.children){const o=this._applyRowFilter(n,t);null!=o&&(e[n.id]=o)}this._updateCheckAll(Object.values(e)),this._updateExternElements(Object.values(e))}_applyRowFilter(t,e){if("row-empty"===t.id)return;const n=t.querySelector("he-check");let o=t.getAttribute("mask")??0;for(const n of e){const e=null!=n.getAttribute("strict-filter"),r=this.$form.querySelector(`.inp-filter[name="${n.getAttribute("column")}"]`);if(null==r)continue;let l=r.value;const i=t.children[n.cellIndex].getAttribute("data");l=l.toLowerCase();(e?i===l:i.toLowerCase().includes(l))?o&=~(1<<n.cellIndex):o|=1<<n.cellIndex}return t.setAttribute("mask",o),o>0?(t.style.visibility="collapse",n.checked=!1):t.style.visibility=null,n.checked?n:null}_checkAllCheckCallback(){this.$checkAll.indeterminate=!1;const t=this.$body.querySelectorAll(".check-row");if(this.$checkAll.checked){for(const e of t)e.checked=!0;this._updateExternElements(t)}else for(const e of t)e.checked=!1,this._updateExternElements([])}_colClickCallback(t){this.$diagColumn.reset();const e=t.getAttribute("column"),n=t.querySelector(".span-colname").innerHTML,o=t.getAttribute("filter"),r=t.getAttribute("description");if(null!=r){this.$diagColumn.querySelector("#lbl-desc").style.display="";let t=this.$diagColumn.querySelector("#desc-column");t.style.display="",t.innerHTML=r}else this.$diagColumn.querySelector("#lbl-desc").style.display="none",this.$diagColumn.querySelector("#desc-column").style.display="none";let l=!1,i=!1;switch(t.getAttribute("sort")){case"desc":l=!0;break;case"asc":i=!0}let s=this.$diagColumn.querySelector("#inp-filter-column"),a=this.$diagColumn.querySelector("#sel-filter-column"),d=this.remap[e]??{},c=this.options[e];null!=c?(c=[...c],c.sort((function(t,e){return t.localeCompare(e)})),c.unshift(""),a.disabled=!1,a.replaceOptions(c,d),a.value=o??"",a.style.display="",s.style.display="none",s.disabled=!0):(s.disabled=!1,s.value=o??"",s.select(),a.disabled=!0,a.style.display="none",s.style.display=""),this.$diagColumn.querySelector("#inp-colname-column").value=e,this.$diagColumn.querySelector("#toggle-asc").checked=i,this.$diagColumn.querySelector("#toggle-desc").checked=l,this.$diagColumn.setAttribute("title-text",n),this.$diagColumn.show()}_columnFromName(t){let e=this._getColumns();for(let n=0;n<e.length;++n){let o=e[n];if(o.getAttribute("column")===t)return o}throw new Error(`No column found with name ${t}`)}_filterChangeCallback(t){this.offset=0;const e=t.currentTarget.value,n=t.currentTarget.closest("td").cellIndex,o=this._getColumns(!1)[n];this._filterColumn(o,e)}_filterColumn(t,e,n=null){const o=t.getAttribute("column");let r=this.$form.querySelector(`.inp-filter[name="${o}"]`);null!=r&&(r.value=e),!1===n?t.removeAttribute("strict-filter"):!0===n&&t.setAttribute("strict-filter",""),""===e?t.removeAttribute("filter"):t.setAttribute("filter",e),null==this.endpoint?this._applyFilters([t]):this._requestRows(this.replaceBody)}_getColumns(t=!1){return t?this.shadowRoot.querySelectorAll("th[column]"):this.shadowRoot.querySelectorAll("th")}_getRowData(t,e=!1){if("row-empty"===t.id)throw new Error("Attempt to get data of empty row!");let n={},o=this._getColumns(!0);for(let r=0;r<o.length;++r){let l=o[r];if(e&&["hidden","check"].includes(l.getAttribute("type")))continue;let i=t.children[l.cellIndex];n[l.getAttribute("column")]=e?i.innerText:i.getAttribute("data")}return n}_getTableData(t=!1){return Array.from(this.$body.children).map((e=>this._getRowData(e,t)))}_handlePagination(){this.offset+=this.pagination??0,this._requestRows(this._appendRows)}_renderButtonMore(){let t=document.createElement("tr");t.id="row-btn-more";let e=document.createElement("td");return e.colSpan="100",e.title="Mehr anzeigen",e.innerHTML="Mehr anzeigen",e.onclick=()=>this._handlePagination(),t.append(e),t}_renderDialogColumn(){let t=document.createElement("he-dialog");t.id="diag-column",t.setAttribute("title-text","Spalte"),t.setAttribute("outside-close","true");let e=document.createElement("form");e.slot="body",e.id="form-column",e.innerHTML='\n            <label id="lbl-desc" style="display: none">Beschreibung</label>\n            <span id="desc-column" style="display: none"></span>\n            <label>Sortierung</label>\n            <div id="cont-sort-diag-col">\n                <he-toggle id="toggle-asc" variant="outline" name="sort" value="asc">A - Z</he-toggle>\n                <he-toggle id="toggle-desc" variant="outline" name="sort" value="desc">Z - A</he-toggle>\n            </div>\n            <label>Filter</label>\n            <he-input id="inp-filter-column" name="filter"></he-input>\n            <he-select id="sel-filter-column" name="filter-sel" filter="true"></he-select>\n            <he-input id="inp-colname-column" type="hidden" name="column"></he-input>\n        ',t.append(e);let n=document.createElement("div");n.slot="footer";let o=document.createElement("he-button");return o.innerHTML="Anwenden",o.setAttribute("variant","primary"),o.onclick=()=>this._applyColumnClickCallback.bind(this)(),n.append(o),t.append(n),t.addEventListener("keyup",(t=>{"Enter"===t.key&&o.click()})),t}_renderDialogEdit(){let t=[];for(let e of this._getColumns(!0)){const n=e.getAttribute("type"),o=e.getAttribute("column");let r="true"===e.getAttribute("required"),l="hidden"===n;e.getAttribute("no-edit")&&(l=!0,r=!1);const i=this.options[o];let s={};if(null!=i){const t=this.remap[o];for(const e of i){if(s[e]=e,null==t)continue;const n=t[e];null!=n&&(s[e]=n)}}t.push({name:e.getAttribute("column"),required:r,label:e.querySelector("span").innerHTML,placeholder:e.getAttribute("default"),pattern:e.getAttribute("pattern"),hidden:l,options:s})}let e=document.createElement("he-form-dialog");return e.renderRows(t),e.setAttribute("endpoint",this.endpoint),e.onsubmit=t=>this.formEditBeforeSubmitCallback.bind(this)(t),e.onresponse=t=>this.formEditAfterSubmitCallback.bind(this)(t),e}_renderRow(t){let e=document.createElement("tr");e.id="row-"+this.nextRowId++,e.onclick=t=>this._rowClickCallback.bind(this)(t);for(let n of this._getColumns()){const o=n.getAttribute("column");let r=t[o]??"",l=r,i=document.createElement("td");switch(n.getAttribute("type")){case"check":let s=document.createElement("he-check");s.name="rows[]",s.value=t.id??"",s.classList.add("check-row"),i.append(s);break;case"edit":i.addEventListener("click",(()=>this._showDialogEdit.bind(this)(e))),i.innerHTML="E";break;case"callback":i.setAttribute("data",r),i.innerHTML=window[n.getAttribute("onrender")](t,o)??"";break;case"hidden":i.style.display="none";default:i.setAttribute("data",r),i.innerHTML=this._renderText(n,l),i.title=r,this._applyCellStyles(i,o,r),this._applyRowStyles(e,o,r)}e.append(i)}return e}_renderRowEmpty(){let t=document.createElement("tr");t.id="row-empty";for(let e=0;e<this._getColumns().length;++e){let e=document.createElement("td");t.append(e)}return t}_requestRows(t){if(null==this.endpoint||this.disableRequest)return;this.loading=!0;let e=new URLSearchParams,n=!1;for(const t of this._getColumns(!0)){const o=t.getAttribute("filter"),r=t.getAttribute("column");null!=o&&""!==o&&e.append(r,o);const l=t.getAttribute("sort");null!=l&&(e.append("sort",r+"-"+l),n=!0)}if(this.getAttribute("require-filter")&&!n)return this.loading=!1,void t.bind(this)([]);null!=this.pagination&&(e.append("offset",this.offset),e.append("count",this.pagination+1)),fetch(this.endpoint+"/?"+e.toString(),{method:"GET"}).then((t=>t.json())).then((e=>{t.bind(this)(e)})).catch((t=>{console.error(t)})).finally((()=>this.loading=!1))}_renderSorters(t,e){let n=document.createElement("input");n.type="radio",n.name="sort",n.value=t+"-asc",n.id=t+"-asc",n.onclick=t=>this._sortClickCallback.bind(this)(t,!1),"asc"===e&&(n.checked=!0);let o=document.createElement("label");o.for=t+"asc",o.innerHTML="▲",o.classList.add("label-sorter"),o.append(n);let r=document.createElement("input");r.type="radio",r.name="sort",r.value=t+"-desc",r.id=t+"-desc",r.onclick=t=>this._sortClickCallback.bind(this)(t,!0),"desc"===e&&(r.checked=!0);let l=document.createElement("label");l.for=t+"desc",l.classList.add("label-sorter"),l.innerHTML="▼",l.append(r);let i=document.createElement("div");return i.classList.add("cont-sorters"),i.append(o),i.append(l),null==this.getAttribute("sorter")&&(i.style.display="none"),i}_renderText(t,e){let n=e;if(""!==(e??""))switch(t.getAttribute("type")){case"date":n=e.split("-").reverse().join(".");break;case"datetime":e=e.replace("T"," ");const[t,o]=e.split(" ");n=t.split("-").reverse().join(".")+" "+o}const o=this.remap[t.getAttribute("column")];if(o){const t=o[e];t&&(n=t)}return n??""}_renderFilter(t,e){let n=null;if(this.options[e]){n=document.createElement("select");let o=document.createElement("option");o.value="",n.append(o);for(const o of this.options[e]){const e=this._renderText(t,o);let r=document.createElement("option");r.innerHTML=e,r.value=o,n.append(r)}}else n=document.createElement("input"),n.type=t.getAttribute("filter-type")??"text",n.autocomplete="efase",n.placeholder=" ";return n.onchange=t=>this._filterChangeCallback(t),n.value=t.getAttribute("filter")??"",n.id="filter-"+e,n.name=e,n.classList.add("inp-filter"),n}_renderHead(t){let e=document.createElement("tr");e.classList.add("row-filter");let n=document.createElement("tr");n.classList.add("row-colName");const o=null!=this.getAttribute("column-menu"),r=this.getAttribute("filter");for(let l of t){let t=l.getAttribute("column")??l.innerText;try{this.options[t]=JSON.parse(l.getAttribute("options"),((t,e,n)=>"number"==typeof e?n.source:e))}catch(t){throw new Error("The provided options are not valid JSON!")}try{this.remap[t]=JSON.parse(l.getAttribute("remap"))}catch(t){throw new Error("The provided remap is not valid JSON!")}try{this.rowColors[t]=JSON.parse(l.getAttribute("row-color"))}catch(t){throw new Error("The provided row-color is not valid JSON!")}try{this.rowStyles[t]=JSON.parse(l.getAttribute("row-style"))}catch(t){throw new Error("The provided row-style is not valid JSON!")}try{this.cellStyles[t]=JSON.parse(l.getAttribute("cell-style"))}catch(t){throw new Error("The provided cell-style is not valid JSON!")}let i=document.createElement("td");e.append(i);"hidden"===l.getAttribute("type")&&(l.style.display="none",i.style.display="none");const s=l.getAttribute("type");switch(s){case"check":this.$checkAll=document.createElement("he-check"),this.$checkAll.id="check-all",this.$checkAll.onchange=t=>this._checkAllCheckCallback.bind(this)(t),l.setAttribute("type","check"),"below"===r?i.append(this.$checkAll):l.append(this.$checkAll),n.append(l);continue;case"edit":case"delete":case"duplicate":let t=document.createElement("th");t.setAttribute("type",s),n.append(t);continue;case"callback":let e=document.createElement("span");e.innerHTML=l.innerHTML.trim(),e.classList.add("span-colname"),l.innerHTML="",l.append(e),n.append(l);continue}let a=document.createElement("div"),d=document.createElement("span");if(d.innerHTML=l.innerHTML.trim(),l.innerHTML="",d.classList.add("span-colname"),o)a.append(d),a.classList.add("cont-colname"),a.addEventListener("click",(()=>this._colClickCallback.bind(this)(l)));else if("below"===r){let e=this._renderFilter(l,t);a.append(d),i.append(e);const n=l.getAttribute("sort");let o=this._renderSorters(t,n);l.setAttribute("column",t),a.append(o)}else a.append(d),d.style.position="unset";l.append(a),n.append(l)}let l=document.createElement("thead");return l.append(n),o||l.append(e),l}_renderTable(){const t=this.shadowRoot,e=this.querySelectorAll("th");this.id=""==this.id?"he-table-"+Math.floor(10000000001*Math.random()):this.id;let n=document.createElement("table");this.$form=document.createElement("form"),this.$form.id="form-tbl",this.$form.append(n),t.append(this.$form);const o=this._renderHead(e);n.append(o),this.$body=document.createElement("tbody");const r=this.querySelectorAll("tr:has(td)");if(0===r.length)this.$body.append(this._renderRowEmpty());else for(const t of r){let n={},o=0;for(let r=0;r<e.length;++r){const l=e[r],i=l.getAttribute("column");if(!i||["check","edit","duplicate","delete"].includes(l.getAttribute("type")))continue;const s=t.children[o],a=s.getAttribute("data")??s.innerText;n[i]=a,++o}let r=this._renderRow(n);this.$body.append(r)}n.append(this.$body),this.$diagEdit=this._renderDialogEdit(),t.append(this.$diagEdit),this.innerHTML="",this.getAttribute("column-menu")&&(this.$diagColumn=this._renderDialogColumn(),t.append(this.$diagColumn))}_rowClickCallback(t){const e=t.currentTarget;let n=null;if(this.$checkAll){const o="false"!==this.$checkAll.parentElement.getAttribute("multiple");if(n=this.$body.querySelectorAll(".check-row:state(checked)"),!o||!t.target.classList.contains("check-row")){for(let t of n)t.checked=!1;e.children[0].children[0].checked=!0}n=this.$body.querySelectorAll(".check-row:state(checked)"),this._updateCheckAll(n)}const o=this.$body.querySelector("tr[selected]");o&&o.removeAttribute("selected"),e.setAttribute("selected",""),this._updateExternElements(n??[e])}_showDialogEdit(t){let e=this._getRowData(t,!1);this.$diagEdit.setValues(e),this.dataOld=e,this.idsEdit=[t.id],this.editRequestType="PATCH",this.$diagEdit.setAttribute("title-text","Bearbeiten"),this.$diagEdit.showModal()}_sortColumn(t,e){if("desc"!==e&&"asc"!==e&&null!=e)throw new Error(`Invalid sort direction: ${e}`);if(null==e)t.removeAttribute("sort");else for(let t of this._getColumns(!0))t.removeAttribute("sort");if(null!=e&&t.setAttribute("sort",e),"below"===this.getAttribute("filter")){let n=this.$form.querySelector("input[name=sort]:checked");if(null!=n&&(n.checked=!1),null!=e){const n=t.getAttribute("column");t.querySelector(`#${n}-${e}`).checked=!0}}if(this.endpoint)return void this._requestRows(this.replaceBody);const n=Array.prototype.indexOf.call(t.parentElement.children,t);let o=[];for(const t of this.$body.children)o.push([t.children[n].getAttribute("data"),t]);let r="desc"===e?Array.from(o).sort(((t,e)=>e[0].localeCompare(t[0]))):Array.from(o).sort(((t,e)=>t[0].localeCompare(e[0])));for(const t of r)this.$body.append(t[1])}_sortClickCallback(t,e){let n=t.currentTarget.closest("th"),o=e?"desc":"asc";this._sortColumn(n,o)}_updateCheckAll(t){this.$checkAll&&(0===t.length?(this.$checkAll.checked=!1,this.$checkAll.indeterminate=!1):t.length<this.$body.children.length?(this.$checkAll.checked=!0,this.$checkAll.indeterminate=!0):(this.$checkAll.indeterminate=!1,this.$checkAll.checked=!0))}_updateExternElements(t){this.getAttribute("name")&&null==this.getAttribute("submit-all")&&this.internals.setFormValue(JSON.stringify(this.value));const e=new CustomEvent("input",{detail:{numRows:t.length}});this.dispatchEvent(e)}}customElements.get("he-table")||customElements.define("he-table",e);export{e as HeliumTable};
